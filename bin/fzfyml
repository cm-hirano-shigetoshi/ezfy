#!/usr/bin/env python
import sys
import yaml
from Task import Task
from Continue import Continue
from Variables import Variables
import subprocess
from subprocess import PIPE

with open(sys.argv[2]) as f:
    yml = yaml.load(f, Loader=yaml.SafeLoader)
variables = Variables(sys.argv)
next_tasks = Continue(yml.get('continue', {}), variables)
base_task = Task(yml['base_task'], variables, next_tasks.get_expect())
task = base_task

if sys.argv[1] == 'run':
    while True:
        proc = subprocess.run(task.get_cmd(), shell=True, stdout=PIPE)
        result = proc.stdout.decode('utf8')
        if len(result) > 0:
            if not task.is_continue(result):
                task.stdout(result)
                break
            else:
                next_task = next_tasks.get(result.split('\n')[1])
                variables.set_pre(result)
                task = base_task.create_continue_task(next_task)
        else:
            break
elif sys.argv[1] == 'debug':
    if len(sys.argv) > 3:
        next_task = next_tasks.get(sys.argv[-1])
        task = task.create_continue_task(next_task)
    print(task.get_cmd())
else:
    raise ValueError("")
