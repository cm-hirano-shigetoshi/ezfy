#!/usr/bin/env bash
set -eu
readonly SUBCMD=$1
shift

function readlink_e() {
  local p
  if ! p=$(readlink -e "$1" 2>/dev/null); then
    p="$1"
    while [[ -L "$p" ]]; do
      p=$(readlink "$p")
    done
  fi
  echo $p
}
readonly PYTHON=/usr/local/bin/python
readonly TOOLDIR=$(dirname $(dirname $(readlink_e ${0})))

if [[ "${SUBCMD}" = "run" ]]; then
  readonly YAML=$1
  shift
  perl <(${PYTHON} ${TOOLDIR}/main/creator.py ${TOOLDIR}/main/template.pl ${YAML}) "$@"
elif [[ "${SUBCMD}" = "debug" ]]; then
  readonly YAML=$1
  shift
  ${PYTHON} ${TOOLDIR}/main/creator.py ${TOOLDIR}/main/template.pl ${YAML}
elif [[ "${SUBCMD}" = "preview" ]]; then
  readonly FILE=$1
  shift
  ${TOOLDIR}/preview/${FILE} "$@"
fi
